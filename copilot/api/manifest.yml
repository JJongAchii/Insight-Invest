# Copilot manifest for API service (Cost-Optimized)
# 
# Type: Backend Service (No ALB - saves ~$16/month)
# Access via: Direct ECS Task Public IP

name: api
type: Backend Service  # ALB 제거 버전 (Load Balanced Web Service → Backend Service)

# Docker image configuration
image:
  build:
    dockerfile: server/Dockerfile
    context: ./server
  port: 8000

# Resource allocation (minimum for cost saving)
cpu: 256       # 0.25 vCPU (최소값)
memory: 512    # 512 MB (최소값)
count: 1       # Single instance (no auto-scaling without ALB)

# Enable command execution for debugging
exec: true

# Environment variables
variables:
  ENVIRONMENT: production
  TZ: Asia/Seoul
  LOG_LEVEL: INFO
  # CORS origins - update with your actual domains
  CORS_ORIGINS: https://insight-invest-ten.vercel.app,http://localhost:3000

# Secrets from AWS Systems Manager Parameter Store
secrets:
  DATABASE_URL: /copilot/${COPILOT_APPLICATION_NAME}/${COPILOT_ENVIRONMENT_NAME}/secrets/DATABASE_URL

# Network configuration
network:
  vpc:
    placement: public  # Public subnet for direct access (no ALB)

# Logging configuration (reduced for cost saving)
logging:
  retention: 7  # 7일 (기존 30일에서 축소)

# Health check (internal only, no ALB)
healthcheck:
  command: ["CMD-SHELL", "curl -f http://localhost:8000/health || exit 1"]
  interval: 30s
  timeout: 5s
  retries: 3
  start_period: 60s

# Note: Without ALB, you'll access the service via:
# - ECS Task Public IP (changes on restart)
# - Or use Route53 to create DNS record pointing to task IP
# - Or use AWS Service Discovery
