# Insight-Invest Data Lake Architecture

> í•˜ì´ë¸Œë¦¬ë“œ ë°ì´í„° ì•„í‚¤í…ì²˜ ì„¤ê³„ ë¬¸ì„œ  
> PostgreSQL (ë©”íƒ€ë°ì´í„°) + Iceberg (ì‹œê³„ì—´ ë°ì´í„°) + Athena (ì¿¼ë¦¬ ì—”ì§„)

**ì‘ì„±ì¼**: 2024-11-22  
**ë²„ì „**: 2.0  
**ìƒíƒœ**: ì„¤ê³„ ë‹¨ê³„

---

## ğŸ“‹ ëª©ì°¨

1. [ê°œìš”](#ê°œìš”)
2. [ì•„í‚¤í…ì²˜ ì„¤ê³„](#ì•„í‚¤í…ì²˜-ì„¤ê³„)
3. [ë°ì´í„° ë ˆì´ì–´ êµ¬ì¡°](#ë°ì´í„°-ë ˆì´ì–´-êµ¬ì¡°)
4. [ìŠ¤í‚¤ë§ˆ ì„¤ê³„](#ìŠ¤í‚¤ë§ˆ-ì„¤ê³„)
5. [ì¿¼ë¦¬ ì—”ì§„ (Athena)](#ì¿¼ë¦¬-ì—”ì§„-athena)
6. [ë°ì´í„° íë¦„](#ë°ì´í„°-íë¦„)
7. [API ë ˆì´ì–´](#api-ë ˆì´ì–´)
8. [ë¹„ìš© ë¶„ì„](#ë¹„ìš©-ë¶„ì„)
9. [ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš](#ë§ˆì´ê·¸ë ˆì´ì…˜-ê³„íš)
10. [ìš´ì˜ ê°€ì´ë“œ](#ìš´ì˜-ê°€ì´ë“œ)

---

## ê°œìš”

### ğŸ¯ ì„¤ê³„ ëª©í‘œ

1. **ë¹„ìš© ìµœì í™”**: RDS ë¹„ìš© 45% ì ˆê° (ì›” $26.28 â†’ $14.83)
2. **í™•ì¥ì„±**: ë°ì´í„° ì¦ê°€ ì‹œ ì„ í˜• ë¹„ìš© ì¦ê°€ (í˜„ì¬: ì§€ìˆ˜ ì¦ê°€)
3. **ìœ ì—°ì„±**: ìŠ¤í‚¤ë§ˆ ë¶„ì‚°ìœ¼ë¡œ ë„ë©”ì¸ë³„ ë…ë¦½ì  ê´€ë¦¬
4. **í˜„ëŒ€í™”**: Pandas ì œê±°, Arrow ë„¤ì´í‹°ë¸Œ ì²˜ë¦¬
5. **ì„œë²„ë¦¬ìŠ¤**: ì¸í”„ë¼ ê´€ë¦¬ ìµœì†Œí™”

### ğŸ”„ ê¸°ì¡´ vs ì‹ ê·œ ì•„í‚¤í…ì²˜

#### ê¸°ì¡´ (í˜„ì¬)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚        FastAPI                      â”‚
â”‚     (SQLAlchemy + Pandas)           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚
             â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚     PostgreSQL (RDS)                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚ - tb_meta (500 rows)         â”‚   â”‚
â”‚  â”‚ - tb_price (3.4 GB)          â”‚   â”‚  â† ì‹œê³„ì—´ ë°ì´í„°ê°€ RDSì—
â”‚  â”‚ - tb_macro_data (2 MB)       â”‚   â”‚     ë¹„ìš© ì¦ê°€ì˜ ì£¼ë²”!
â”‚  â”‚ - tb_nav (227 MB)            â”‚   â”‚
â”‚  â”‚ - tb_portfolio (10 KB)       â”‚   â”‚
â”‚  â”‚ - tb_strategy (1 KB)         â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ë¬¸ì œì :
âŒ RDS ìŠ¤í† ë¦¬ì§€ ë¹„ìš© ë†’ìŒ ($5.75/ì›”, 50GB)
âŒ ë°±ì—… ë¹„ìš© ë†’ìŒ ($4.75/ì›”)
âŒ ë°ì´í„° ì¦ê°€ ì‹œ ë¹„ìš© ê¸‰ì¦
âŒ í™•ì¥ ì œí•œ (ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤)
âŒ Pandas ì˜ì¡´ë„ ë†’ìŒ
```

#### ì‹ ê·œ (ëª©í‘œ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    FastAPI (API Layer)                    â”‚
â”‚                  Arrow ë„¤ì´í‹°ë¸Œ, Pandas ì—†ìŒ               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
         â”‚                                 â”‚
         â”‚ Meta Query                      â”‚ Time-series Query
         â”‚                                 â”‚
         â–¼                                 â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  PostgreSQL      â”‚            â”‚   AWS Athena             â”‚
â”‚  (ë©”íƒ€ë°ì´í„°ë§Œ)   â”‚            â”‚   (ì„œë²„ë¦¬ìŠ¤ ì¿¼ë¦¬ ì—”ì§„)    â”‚
â”‚                  â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ - tb_meta        â”‚                     â”‚
â”‚ - tb_strategy    â”‚                     â”‚
â”‚ - tb_portfolio   â”‚                     â–¼
â”‚ - tb_universe    â”‚            â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ - tb_metrics     â”‚            â”‚  AWS Glue Catalog        â”‚
â”‚                  â”‚            â”‚  (ë©”íƒ€ìŠ¤í† ì–´)             â”‚
â”‚ í¬ê¸°: ~1 MB      â”‚            â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚ ë¹„ìš©: $14.43/ì›”  â”‚                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                     â”‚
                                         â–¼
                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                              â”‚  Apache Iceberg Tables       â”‚
                              â”‚  (S3ì— ì €ì¥)                 â”‚
                              â”‚                              â”‚
                              â”‚  market_data/                â”‚
                              â”‚    - us_stocks_price         â”‚
                              â”‚    - kr_stocks_price         â”‚
                              â”‚  portfolio/                  â”‚
                              â”‚    - tb_nav                  â”‚
                              â”‚    - tb_rebalance            â”‚
                              â”‚  analytics/                  â”‚
                              â”‚    - tb_signals              â”‚
                              â”‚  reference/                  â”‚
                              â”‚    - tb_macro_data           â”‚
                              â”‚                              â”‚
                              â”‚  í¬ê¸°: ~1 GB (ì••ì¶•)          â”‚
                              â”‚  ë¹„ìš©: $0.25/ì›”              â”‚
                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ì¥ì :
âœ… ë¹„ìš© 45% ì ˆê° ($11.45/ì›”)
âœ… ë¬´í•œ í™•ì¥ ê°€ëŠ¥
âœ… ìŠ¤í‚¤ë§ˆ ë¶„ì‚°ìœ¼ë¡œ ìœ ì—°ì„± í–¥ìƒ
âœ… Arrow ë„¤ì´í‹°ë¸Œ (Pandas ì œê±°)
âœ… ì„œë²„ë¦¬ìŠ¤ (ì¸í”„ë¼ ê´€ë¦¬ ìµœì†Œ)
âœ… ACID, Time Travel ì§€ì›
```

---

## ì•„í‚¤í…ì²˜ ì„¤ê³„

### ğŸ—ï¸ ì „ì²´ ì‹œìŠ¤í…œ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                              Client Layer                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  Next.js Frontend (Vercel)                                       â”‚   â”‚
â”‚  â”‚  - TradingView ì°¨íŠ¸                                              â”‚   â”‚
â”‚  â”‚  - ë°±í…ŒìŠ¤íŠ¸ ì‹œë®¬ë ˆì´ì…˜                                            â”‚   â”‚
â”‚  â”‚  - í¬íŠ¸í´ë¦¬ì˜¤ ë¶„ì„                                               â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚ HTTPS
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          API Gateway Layer                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  ALB (Application Load Balancer)                                 â”‚   â”‚
â”‚  â”‚  - Health Check                                                  â”‚   â”‚
â”‚  â”‚  - Auto Scaling Trigger                                          â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â”‚
                            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         Application Layer                               â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  FastAPI Server (ECS Fargate)                                    â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚   â”‚
â”‚  â”‚  â”‚  Routers:                                                   â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - /api/meta       â†’ PostgreSQL                            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - /api/price      â†’ Athena (Iceberg)                      â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - /api/backtest   â†’ Athena (Iceberg) + Compute            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - /api/portfolio  â†’ Athena (Cross-schema JOIN)            â”‚  â”‚   â”‚
â”‚  â”‚  â”‚  - /api/regime     â†’ Athena (Iceberg)                      â”‚  â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚   â”‚
â”‚  â”‚                                                                   â”‚   â”‚
â”‚  â”‚  Libraries:                                                       â”‚   â”‚
â”‚  â”‚  - boto3 (Athena Client)                                         â”‚   â”‚
â”‚  â”‚  - pyarrow (Arrow ë„¤ì´í‹°ë¸Œ)                                      â”‚   â”‚
â”‚  â”‚  - SQLAlchemy (PostgreSQL)                                       â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚                              â”‚
                â”‚ Meta Query                   â”‚ Time-series Query
                â”‚                              â”‚
                â–¼                              â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”      â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Metadata Store         â”‚      â”‚  Query Engine Layer                  â”‚
â”‚  (PostgreSQL - RDS)     â”‚      â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚                         â”‚      â”‚  â”‚  AWS Athena (Serverless)       â”‚  â”‚
â”‚  Tables:                â”‚      â”‚  â”‚                                â”‚  â”‚
â”‚  - tb_meta              â”‚      â”‚  â”‚  Features:                     â”‚  â”‚
â”‚  - tb_strategy          â”‚      â”‚  â”‚  - SQL ì¿¼ë¦¬ ì—”ì§„               â”‚  â”‚
â”‚  - tb_portfolio         â”‚      â”‚  â”‚  - Auto Scaling                â”‚  â”‚
â”‚  - tb_universe          â”‚      â”‚  â”‚  - Arrow ë„¤ì´í‹°ë¸Œ              â”‚  â”‚
â”‚  - tb_metrics           â”‚      â”‚  â”‚  - Partition Pruning           â”‚  â”‚
â”‚  (ì‘ê³  ìì£¼ ë³€ê²½)        â”‚      â”‚  â”‚  - Cost: $5/TB scanned         â”‚  â”‚
â”‚                         â”‚      â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  Size: ~1 MB            â”‚      â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
â”‚  Cost: $14.43/ì›”        â”‚                      â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜                      â”‚
                                                 â–¼
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚  Metadata Layer                      â”‚
                                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                                   â”‚  â”‚  AWS Glue Data Catalog         â”‚  â”‚
                                   â”‚  â”‚  (Hive Metastore Compatible)   â”‚  â”‚
                                   â”‚  â”‚                                â”‚  â”‚
                                   â”‚  â”‚  Databases:                    â”‚  â”‚
                                   â”‚  â”‚  - market_data                 â”‚  â”‚
                                   â”‚  â”‚  - portfolio                   â”‚  â”‚
                                   â”‚  â”‚  - analytics                   â”‚  â”‚
                                   â”‚  â”‚  - reference                   â”‚  â”‚
                                   â”‚  â”‚                                â”‚  â”‚
                                   â”‚  â”‚  Tables: 10-20ê°œ               â”‚  â”‚
                                   â”‚  â”‚  Cost: $0.10/ì›”                â”‚  â”‚
                                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                                   â–¼
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚  Table Format Layer                  â”‚
                                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                                   â”‚  â”‚  Apache Iceberg                â”‚  â”‚
                                   â”‚  â”‚                                â”‚  â”‚
                                   â”‚  â”‚  Features:                     â”‚  â”‚
                                   â”‚  â”‚  - ACID Transactions           â”‚  â”‚
                                   â”‚  â”‚  - Time Travel                 â”‚  â”‚
                                   â”‚  â”‚  - Schema Evolution            â”‚  â”‚
                                   â”‚  â”‚  - Hidden Partitioning         â”‚  â”‚
                                   â”‚  â”‚  - Incremental Read            â”‚  â”‚
                                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                                   â”‚
                                                   â–¼
                                   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                                   â”‚  Storage Layer                       â”‚
                                   â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                                   â”‚  â”‚  Amazon S3                     â”‚  â”‚
                                   â”‚  â”‚                                â”‚  â”‚
                                   â”‚  â”‚  s3://insight-invest-datalake/ â”‚  â”‚
                                   â”‚  â”‚  â”œâ”€â”€ warehouse/                â”‚  â”‚
                                   â”‚  â”‚  â”‚   â”œâ”€â”€ market_data/          â”‚  â”‚
                                   â”‚  â”‚  â”‚   â”œâ”€â”€ portfolio/            â”‚  â”‚
                                   â”‚  â”‚  â”‚   â”œâ”€â”€ analytics/            â”‚  â”‚
                                   â”‚  â”‚  â”‚   â””â”€â”€ reference/            â”‚  â”‚
                                   â”‚  â”‚  â””â”€â”€ raw/ (ì›ì‹œ ë°ì´í„°)        â”‚  â”‚
                                   â”‚  â”‚                                â”‚  â”‚
                                   â”‚  â”‚  Format: Parquet (Zstd ì••ì¶•)  â”‚  â”‚
                                   â”‚  â”‚  Size: ~1 GB (ì••ì¶• í›„)         â”‚  â”‚
                                   â”‚  â”‚  Cost: $0.15/ì›”                â”‚  â”‚
                                   â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Data Ingestion Layer                           â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚  â”‚  AWS EventBridge (Scheduler)                                     â”‚   â”‚
â”‚  â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”           â”‚   â”‚
â”‚  â”‚  â”‚ US Price     â”‚  â”‚ KR Price     â”‚  â”‚ Macro Data   â”‚           â”‚   â”‚
â”‚  â”‚  â”‚ Updater      â”‚  â”‚ Updater      â”‚  â”‚ Updater      â”‚           â”‚   â”‚
â”‚  â”‚  â”‚ (ë§¤ì¼ 09:00) â”‚  â”‚ (ë§¤ì¼ 21:00) â”‚  â”‚ (ë§¤ì¼ 23:00) â”‚           â”‚   â”‚
â”‚  â”‚  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜           â”‚   â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                  â”‚                  â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  ECS Tasks (Fargate)     â”‚
                    â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
                    â”‚  â”‚  PyIceberg Writer  â”‚  â”‚
                    â”‚  â”‚  - yfinance        â”‚  â”‚
                    â”‚  â”‚  - FRED API        â”‚  â”‚
                    â”‚  â”‚  - Arrow Transform â”‚  â”‚
                    â”‚  â”‚  - Iceberg Append  â”‚  â”‚
                    â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                â”‚
                                â–¼
                    (S3 Iceberg Tablesì— ì§ì ‘ ì“°ê¸°)
```

---

## ë°ì´í„° ë ˆì´ì–´ êµ¬ì¡°

### ğŸ“Š 4-Layer Architecture

```
Layer 1: Storage (ë¬¼ë¦¬ì  ì €ì¥ì†Œ)
  â””â”€ Amazon S3
     - ì €ë ´í•œ ìŠ¤í† ë¦¬ì§€ ($0.023/GB)
     - ë¬´í•œ í™•ì¥
     - Intelligent Tiering (ìë™ ë¹„ìš© ìµœì í™”)

Layer 2: Table Format (í…Œì´ë¸” í¬ë§·)
  â””â”€ Apache Iceberg
     - ACID íŠ¸ëœì­ì…˜
     - Time Travel (ê³¼ê±° ë°ì´í„° ì¡°íšŒ)
     - Schema Evolution (ìŠ¤í‚¤ë§ˆ ë³€ê²½ ììœ )
     - Hidden Partitioning (ìë™ íŒŒí‹°ì…˜ ê´€ë¦¬)
     - Incremental Read (ì¦ë¶„ ì½ê¸°)

Layer 3: Metadata Store (ë©”íƒ€ë°ì´í„° ì €ì¥ì†Œ)
  â””â”€ AWS Glue Data Catalog
     - í…Œì´ë¸” ì •ì˜ (ìŠ¤í‚¤ë§ˆ)
     - íŒŒí‹°ì…˜ ì •ë³´
     - Iceberg ë©”íƒ€ë°ì´í„° í¬ì¸í„°
     - Hive Metastore í˜¸í™˜

Layer 4: Query Engine (ì¿¼ë¦¬ ì—”ì§„)
  â””â”€ AWS Athena
     - ì„œë²„ë¦¬ìŠ¤ SQL ì—”ì§„
     - Arrow ë„¤ì´í‹°ë¸Œ
     - ìë™ í™•ì¥
     - Pay-per-query
```

### ğŸ—„ï¸ ë°ì´í„° ë¶„ë¥˜

#### ë©”íƒ€ë°ì´í„° (PostgreSQLì— ìœ ì§€)

```sql
-- ì‘ê³ , ìì£¼ ë³€ê²½ë˜ê³ , ê´€ê³„ê°€ ë³µì¡í•œ ë°ì´í„°

tb_meta (500 rows)
  - meta_id (PK)
  - ticker
  - name
  - sector
  - iso_code

tb_strategy (10 rows)
  - strategy_id (PK)
  - strategy
  - strategy_name

tb_portfolio (100 rows)
  - port_id (PK)
  - port_name
  - strategy_id (FK)

tb_universe (5,000 rows)
  - port_id (FK)
  - meta_id (FK)

ì´ í¬ê¸°: ~1 MB
íŠ¹ì§•:
  âœ… ACID íŠ¸ëœì­ì…˜ í•„ìš”
  âœ… ë³µì¡í•œ FK ê´€ê³„
  âœ… ìì£¼ ì—…ë°ì´íŠ¸
  âœ… ì‘ì€ ë°ì´í„°
```

#### ì‹œê³„ì—´ ë°ì´í„° (Icebergë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜)

```
í¬ê³ , Append-only, ì‹œê°„ ê¸°ë°˜ íŒŒí‹°ì…˜

market_data/us_stocks_price (2.5 GB)
  - meta_id
  - trade_date (íŒŒí‹°ì…˜ í‚¤)
  - close, adj_close, gross_return
  - íŒŒí‹°ì…˜: ì›”ë³„ (trade_month)

market_data/kr_stocks_price (650 MB)
  - ë™ì¼ ìŠ¤í‚¤ë§ˆ
  - íŒŒí‹°ì…˜: ì›”ë³„

portfolio/tb_nav (227 MB)
  - trade_date (íŒŒí‹°ì…˜ í‚¤)
  - port_id
  - value
  - íŒŒí‹°ì…˜: ì›”ë³„

portfolio/tb_rebalance (4 MB)
  - rebal_date (íŒŒí‹°ì…˜ í‚¤)
  - port_id, meta_id, weight
  - íŒŒí‹°ì…˜: ì—°ë³„

reference/tb_macro_data (2 MB)
  - macro_id
  - base_date (íŒŒí‹°ì…˜ í‚¤)
  - value
  - íŒŒí‹°ì…˜: ì›”ë³„

ì´ í¬ê¸°: ~3.4 GB (ì••ì¶• í›„ ~1 GB)
íŠ¹ì§•:
  âœ… Append-only
  âœ… ì‹œê°„ ê¸°ë°˜ ì¿¼ë¦¬
  âœ… ëŒ€ìš©ëŸ‰
  âœ… íŒŒí‹°ì…˜ ìµœì í™” ì¤‘ìš”
```

---

## ìŠ¤í‚¤ë§ˆ ì„¤ê³„

### ğŸ¢ Glue Database (ìŠ¤í‚¤ë§ˆ) êµ¬ì¡°

```
AWS Glue Catalog
â”œâ”€â”€ market_data (ì‹œì¥ ë°ì´í„°)
â”‚   â”œâ”€â”€ us_stocks_price
â”‚   â”‚   â””â”€â”€ Partition: trade_month
â”‚   â”œâ”€â”€ kr_stocks_price
â”‚   â”‚   â””â”€â”€ Partition: trade_month
â”‚   â””â”€â”€ intraday_price (ë¯¸ë˜ í™•ì¥)
â”‚       â””â”€â”€ Partition: trade_date
â”‚
â”œâ”€â”€ portfolio (í¬íŠ¸í´ë¦¬ì˜¤ ê´€ë ¨)
â”‚   â”œâ”€â”€ tb_nav
â”‚   â”‚   â””â”€â”€ Partition: trade_month
â”‚   â”œâ”€â”€ tb_rebalance
â”‚   â”‚   â””â”€â”€ Partition: rebal_year
â”‚   â””â”€â”€ tb_holdings (ë¯¸ë˜ í™•ì¥)
â”‚       â””â”€â”€ Partition: snapshot_date
â”‚
â”œâ”€â”€ analytics (ë¶„ì„ ë° ë©”íŠ¸ë¦­)
â”‚   â”œâ”€â”€ tb_signals (ê±°ë˜ ì‹ í˜¸)
â”‚   â”‚   â””â”€â”€ Partition: signal_date
â”‚   â”œâ”€â”€ tb_backtests (ë°±í…ŒìŠ¤íŠ¸ ê²°ê³¼)
â”‚   â”‚   â””â”€â”€ Partition: run_date
â”‚   â””â”€â”€ tb_factor_returns (íŒ©í„° ìˆ˜ìµë¥ )
â”‚       â””â”€â”€ Partition: calc_month
â”‚
â””â”€â”€ reference (ì°¸ì¡° ë°ì´í„°)
    â”œâ”€â”€ tb_macro_data
    â”‚   â””â”€â”€ Partition: base_month
    â”œâ”€â”€ tb_calendar (ê±°ë˜ì¼ ìº˜ë¦°ë”)
    â”‚   â””â”€â”€ Partition: year
    â””â”€â”€ tb_exchange_rates (í™˜ìœ¨)
        â””â”€â”€ Partition: date_month
```

### ğŸ“‹ í…Œì´ë¸” ìƒì„¸ ìŠ¤í‚¤ë§ˆ

#### 1. market_data.us_stocks_price

```python
from pyiceberg.schema import Schema
from pyiceberg.types import *

Schema(
    NestedField(1, "meta_id", IntegerType(), required=True),
    NestedField(2, "trade_date", DateType(), required=True),
    NestedField(3, "close", DoubleType()),
    NestedField(4, "adj_close", DoubleType()),
    NestedField(5, "gross_return", DoubleType()),
    NestedField(6, "volume", LongType()),
    NestedField(7, "updated_at", TimestampType()),
)

# Partition Spec
PartitionSpec(
    PartitionField(
        source_id=2,  # trade_date
        field_id=1000,
        transform=MonthTransform(),
        name="trade_month"
    )
)

# Table Properties
{
    "write.format.default": "parquet",
    "write.parquet.compression-codec": "zstd",
    "write.parquet.row-group-size": "134217728",  # 128 MB
    "write.metadata.compression-codec": "gzip",
}

# S3 Location
s3://insight-invest-datalake/warehouse/market_data/us_stocks_price/
```

#### 2. portfolio.tb_nav

```python
Schema(
    NestedField(1, "trade_date", DateType(), required=True),
    NestedField(2, "port_id", IntegerType(), required=True),
    NestedField(3, "value", DoubleType(), required=True),
    NestedField(4, "cash", DoubleType()),
    NestedField(5, "total_value", DoubleType()),
    NestedField(6, "updated_at", TimestampType()),
)

# Partition Spec
PartitionSpec(
    PartitionField(
        source_id=1,  # trade_date
        field_id=1000,
        transform=MonthTransform(),
        name="trade_month"
    )
)

# Primary Key (Iceberg)
# ë³µí•© í‚¤: (trade_date, port_id)
```

#### 3. reference.tb_macro_data

```python
Schema(
    NestedField(1, "macro_id", IntegerType(), required=True),
    NestedField(2, "base_date", DateType(), required=True),
    NestedField(3, "value", DoubleType()),
    NestedField(4, "fred_series_id", StringType()),
    NestedField(5, "updated_at", TimestampType()),
)

# Partition Spec
PartitionSpec(
    PartitionField(
        source_id=2,  # base_date
        field_id=1000,
        transform=MonthTransform(),
        name="base_month"
    )
)
```

---

## ì¿¼ë¦¬ ì—”ì§„ (Athena)

### ğŸ” Athena ì‘ë™ ì›ë¦¬

#### ì¿¼ë¦¬ ì‹¤í–‰ í”Œë¡œìš°

```
1. SQL ì¿¼ë¦¬ ì œì¶œ
   â†“
   FastAPIì—ì„œ boto3ë¡œ Athena í˜¸ì¶œ

2. Query Planning
   â†“
   Athenaê°€ Glue Catalogì—ì„œ í…Œì´ë¸” ë©”íƒ€ë°ì´í„° ì¡°íšŒ
   - í…Œì´ë¸” íƒ€ì… í™•ì¸ (ICEBERG)
   - ìŠ¤í‚¤ë§ˆ ì •ë³´
   - íŒŒí‹°ì…˜ ì •ë³´
   - S3 ìœ„ì¹˜

3. Iceberg Metadata ì½ê¸°
   â†“
   S3ì—ì„œ Iceberg ë©”íƒ€ë°ì´í„° íŒŒì¼ ì½ê¸°
   - metadata/v5.metadata.json
   - í˜„ì¬ ìŠ¤ëƒ…ìƒ· ì •ë³´
   - íŒŒí‹°ì…˜ ì •ë³´
   - ë°ì´í„° íŒŒì¼ ëª©ë¡

4. Partition Pruning
   â†“
   WHERE ì ˆ ì¡°ê±´ìœ¼ë¡œ ë¶ˆí•„ìš”í•œ íŒŒí‹°ì…˜ ì œì™¸
   ì˜ˆ: trade_date >= '2024-01-01'
   â†’ 2023ë…„ ì´ì „ íŒŒí‹°ì…˜ ìŠ¤í‚µ

5. Column Projection
   â†“
   SELECT ì ˆì— ëª…ì‹œëœ ì»¬ëŸ¼ë§Œ ì½ê¸°
   ì˜ˆ: SELECT trade_date, adj_close
   â†’ close, volume ì»¬ëŸ¼ì€ ìŠ¤í‚µ

6. Data Scanning
   â†“
   S3ì—ì„œ í•„í„°ë§ëœ Parquet íŒŒì¼ë§Œ ì½ê¸°
   - ë³‘ë ¬ ìŠ¤ìº” (ìë™ í™•ì¥)
   - Parquetì˜ ì»¬ëŸ¼ ê¸°ë°˜ ì €ì¥ í™œìš©

7. ê²°ê³¼ ë°˜í™˜
   â†“
   S3ì— ê²°ê³¼ ì €ì¥ (Parquet)
   â†’ FastAPIì—ì„œ Arrowë¡œ ì½ê¸°
```

#### ì˜ˆì‹œ: ì¿¼ë¦¬ ìµœì í™”

```sql
-- âŒ ë¹„íš¨ìœ¨ì ì¸ ì¿¼ë¦¬
SELECT *
FROM market_data.us_stocks_price
WHERE meta_id = 123

-- ìŠ¤ìº”ëŸ‰: ì „ì²´ í…Œì´ë¸” (3 GB)
-- ë¹„ìš©: $0.015
-- ì‹œê°„: 8-10ì´ˆ


-- âœ… ìµœì í™”ëœ ì¿¼ë¦¬
SELECT trade_date, adj_close
FROM market_data.us_stocks_price
WHERE trade_date >= DATE '2024-11-01'
  AND trade_date < DATE '2024-12-01'
  AND meta_id = 123

-- ìŠ¤ìº”ëŸ‰: 11ì›” íŒŒí‹°ì…˜ë§Œ (30 MB)
-- ë¹„ìš©: $0.00015
-- ì‹œê°„: 2-3ì´ˆ

ìµœì í™” íš¨ê³¼: ë¹„ìš© 99% ê°ì†Œ, ì†ë„ 3ë°° í–¥ìƒ!
```

### ğŸ”— í¬ë¡œìŠ¤ ìŠ¤í‚¤ë§ˆ ì¡°ì¸

```sql
-- 3ê°œ ìŠ¤í‚¤ë§ˆë¥¼ JOINí•˜ëŠ” ë³µì¡í•œ ì¿¼ë¦¬
-- Athenaê°€ ìë™ìœ¼ë¡œ ìµœì í™”

SELECT
    p.trade_date,
    m.ticker,
    m.name,
    p.adj_close,
    n.value as portfolio_nav,
    a.sharpe,
    r.weight
FROM market_data.us_stocks_price p          -- ìŠ¤í‚¤ë§ˆ 1
JOIN reference.tb_meta m                     -- PostgreSQL
    ON p.meta_id = m.meta_id
JOIN portfolio.tb_nav n                      -- ìŠ¤í‚¤ë§ˆ 2
    ON p.trade_date = n.trade_date
JOIN analytics.tb_metrics a                  -- ìŠ¤í‚¤ë§ˆ 3
    ON n.port_id = a.port_id
JOIN portfolio.tb_rebalance r                -- ìŠ¤í‚¤ë§ˆ 2
    ON p.meta_id = r.meta_id
    AND p.trade_date >= r.rebal_date
WHERE p.trade_date >= DATE '2024-01-01'
  AND n.port_id = 1

-- Athenaì˜ ìë™ ìµœì í™”:
-- 1. Partition Pruning (p.trade_date í•„í„°)
-- 2. Join Reordering (ì‘ì€ í…Œì´ë¸” ë¨¼ì €)
-- 3. Pushdown Filtering (í•„í„°ë¥¼ ìŠ¤ìº” ë‹¨ê³„ë¡œ í‘¸ì‹œ)
-- 4. ë³‘ë ¬ ì²˜ë¦¬
```

### ğŸ¯ Athena ì‚¬ìš© íŒ¨í„´

#### Pattern 1: ë‹¨ìˆœ ì¡°íšŒ (Fast)

```python
# íŠ¹ì • ì¢…ëª©ì˜ ìµœê·¼ ê°€ê²©
result = athena.query_to_json("""
    SELECT trade_date, adj_close
    FROM market_data.us_stocks_price
    WHERE meta_id = 123
      AND trade_date >= CURRENT_DATE - INTERVAL '30' DAY
    ORDER BY trade_date DESC
""")

# ì‘ë‹µ ì‹œê°„: 2-3ì´ˆ
# ìŠ¤ìº”ëŸ‰: ~10 MB
# ë¹„ìš©: $0.00005
```

#### Pattern 2: ì§‘ê³„ ì¿¼ë¦¬ (Medium)

```python
# ì›”ë³„ í‰ê·  ê°€ê²©
result = athena.query_to_json("""
    SELECT
        DATE_TRUNC('month', trade_date) as month,
        AVG(adj_close) as avg_price,
        STDDEV(gross_return) as volatility
    FROM market_data.us_stocks_price
    WHERE meta_id IN (1, 2, 3, 4, 5)
      AND trade_date >= DATE '2024-01-01'
    GROUP BY DATE_TRUNC('month', trade_date)
    ORDER BY month
""")

# ì‘ë‹µ ì‹œê°„: 3-5ì´ˆ
# ìŠ¤ìº”ëŸ‰: ~100 MB
# ë¹„ìš©: $0.0005
```

#### Pattern 3: ë³µì¡í•œ ë¶„ì„ (Slow but Powerful)

```python
# í¬íŠ¸í´ë¦¬ì˜¤ ì„±ê³¼ ë¶„ì„ (ì—¬ëŸ¬ ìŠ¤í‚¤ë§ˆ ì¡°ì¸)
result = athena.query_to_json("""
    WITH portfolio_returns AS (
        SELECT
            n.trade_date,
            n.port_id,
            n.value,
            LAG(n.value) OVER (
                PARTITION BY n.port_id
                ORDER BY n.trade_date
            ) as prev_value
        FROM portfolio.tb_nav n
        WHERE n.port_id = 1
          AND n.trade_date >= DATE '2024-01-01'
    ),
    daily_returns AS (
        SELECT
            trade_date,
            (value - prev_value) / prev_value as daily_return
        FROM portfolio_returns
        WHERE prev_value IS NOT NULL
    )
    SELECT
        COUNT(*) as trading_days,
        AVG(daily_return) * 252 as annualized_return,
        STDDEV(daily_return) * SQRT(252) as annualized_vol,
        AVG(daily_return) / STDDEV(daily_return) * SQRT(252) as sharpe_ratio
    FROM daily_returns
""")

# ì‘ë‹µ ì‹œê°„: 5-8ì´ˆ
# ìŠ¤ìº”ëŸ‰: ~200 MB
# ë¹„ìš©: $0.001
```

---

## ë°ì´í„° íë¦„

### ğŸ“¥ Data Ingestion (ë°ì´í„° ìˆ˜ì§‘)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  EventBridge Scheduler                              â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  Cron: 0 9 * * TUE-SAT (ë§¤ì¼ 09:00 UTC)   â”‚     â”‚
â”‚  â”‚  Target: ECS Task (us-price-updater)       â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ECS Task: us-price-updater                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  1. yfinanceë¡œ ì£¼ê°€ ë°ì´í„° ë‹¤ìš´ë¡œë“œ        â”‚     â”‚
â”‚  â”‚     â†“                                      â”‚     â”‚
â”‚  â”‚  2. Pandas â†’ Arrow ë³€í™˜                   â”‚     â”‚
â”‚  â”‚     â†“                                      â”‚     â”‚
â”‚  â”‚  3. PyIcebergë¡œ í…Œì´ë¸” ë¡œë“œ               â”‚     â”‚
â”‚  â”‚     catalog.load_table("market_data...")  â”‚     â”‚
â”‚  â”‚     â†“                                      â”‚     â”‚
â”‚  â”‚  4. Icebergì— append                      â”‚     â”‚
â”‚  â”‚     table.append(arrow_table)             â”‚     â”‚
â”‚  â”‚     â†“                                      â”‚     â”‚
â”‚  â”‚  5. ë©”íƒ€ë°ì´í„° ì—…ë°ì´íŠ¸ (ìë™)            â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  S3ì— ë°ì´í„° ì €ì¥                                    â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  s3://warehouse/market_data/us_stocks/     â”‚     â”‚
â”‚  â”‚  â”œâ”€â”€ metadata/                             â”‚     â”‚
â”‚  â”‚  â”‚   â”œâ”€â”€ v123.metadata.json (ì—…ë°ì´íŠ¸)     â”‚     â”‚
â”‚  â”‚  â”‚   â””â”€â”€ snap-456.avro (ìƒˆ ìŠ¤ëƒ…ìƒ·)         â”‚     â”‚
â”‚  â”‚  â””â”€â”€ data/                                 â”‚     â”‚
â”‚  â”‚      â””â”€â”€ trade_month=2024-11/              â”‚     â”‚
â”‚  â”‚          â””â”€â”€ 00123-0-data.parquet (ìƒˆ íŒŒì¼)â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Glue Catalog ìë™ ë™ê¸°í™”                            â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  - ìƒˆ íŒŒí‹°ì…˜ ë“±ë¡                          â”‚     â”‚
â”‚  â”‚  - í†µê³„ ì •ë³´ ì—…ë°ì´íŠ¸                      â”‚     â”‚
â”‚  â”‚  - ìŠ¤ëƒ…ìƒ· ì •ë³´ ê°±ì‹                         â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“¤ Data Querying (ë°ì´í„° ì¡°íšŒ)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend (Next.js)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  GET /api/price/daily?ticker=AAPL          â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI Router                                      â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  @router.get("/price/daily")               â”‚     â”‚
â”‚  â”‚  def get_daily_prices(ticker: str):        â”‚     â”‚
â”‚  â”‚      # 1. meta_id ì¡°íšŒ (PostgreSQL)        â”‚     â”‚
â”‚  â”‚      meta_id = get_meta_id(ticker)         â”‚     â”‚
â”‚  â”‚                                            â”‚     â”‚
â”‚  â”‚      # 2. Athena ì¿¼ë¦¬ ìƒì„±                 â”‚     â”‚
â”‚  â”‚      sql = f"""                            â”‚     â”‚
â”‚  â”‚          SELECT trade_date, adj_close      â”‚     â”‚
â”‚  â”‚          FROM market_data.us_stocks_price  â”‚     â”‚
â”‚  â”‚          WHERE meta_id = {meta_id}         â”‚     â”‚
â”‚  â”‚      """                                   â”‚     â”‚
â”‚  â”‚                                            â”‚     â”‚
â”‚  â”‚      # 3. Athena ì‹¤í–‰                      â”‚     â”‚
â”‚  â”‚      return athena.query_to_json(sql)      â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  AWS Athena                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  1. Glue Catalog ì¡°íšŒ                      â”‚     â”‚
â”‚  â”‚     â†’ í…Œì´ë¸” ë©”íƒ€ë°ì´í„° íšë“               â”‚     â”‚
â”‚  â”‚     â†“                                      â”‚     â”‚
â”‚  â”‚  2. Iceberg ë©”íƒ€ë°ì´í„° ì½ê¸°                â”‚     â”‚
â”‚  â”‚     â†’ S3ì—ì„œ metadata.json ì½ê¸°            â”‚     â”‚
â”‚  â”‚     â†“                                      â”‚     â”‚
â”‚  â”‚  3. Partition Pruning                      â”‚     â”‚
â”‚  â”‚     â†’ í•„ìš”í•œ íŒŒí‹°ì…˜ë§Œ ì„ íƒ                 â”‚     â”‚
â”‚  â”‚     â†“                                      â”‚     â”‚
â”‚  â”‚  4. ë°ì´í„° ìŠ¤ìº”                            â”‚     â”‚
â”‚  â”‚     â†’ S3ì—ì„œ Parquet íŒŒì¼ ì½ê¸°             â”‚     â”‚
â”‚  â”‚     â†“                                      â”‚     â”‚
â”‚  â”‚  5. ê²°ê³¼ ìƒì„±                              â”‚     â”‚
â”‚  â”‚     â†’ S3ì— ê²°ê³¼ ì €ì¥ (Parquet)             â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  FastAPI (ê²°ê³¼ ì²˜ë¦¬)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  1. S3ì—ì„œ ê²°ê³¼ íŒŒì¼ ì½ê¸°                  â”‚     â”‚
â”‚  â”‚     â†“                                      â”‚     â”‚
â”‚  â”‚  2. Arrow Tableë¡œ ë¡œë“œ                     â”‚     â”‚
â”‚  â”‚     (Pandas ì—†ìŒ!)                         â”‚     â”‚
â”‚  â”‚     â†“                                      â”‚     â”‚
â”‚  â”‚  3. JSONìœ¼ë¡œ ë³€í™˜                          â”‚     â”‚
â”‚  â”‚     arrow_table.to_pylist()                â”‚     â”‚
â”‚  â”‚     â†“                                      â”‚     â”‚
â”‚  â”‚  4. HTTP ì‘ë‹µ                              â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                â”‚
                â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Frontend (Next.js)                                 â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”‚
â”‚  â”‚  ì°¨íŠ¸ ë Œë”ë§                                â”‚     â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## API ë ˆì´ì–´

### ğŸŒ FastAPI ë¼ìš°í„° êµ¬ì¡°

```python
# server/app/main.py
from fastapi import FastAPI
from app.routers import (
    meta,           # PostgreSQL
    price,          # Athena + Iceberg
    backtest,       # Athena + Iceberg + Compute
    portfolio,      # Athena (Cross-schema)
    regime,         # Athena + Iceberg
)

app = FastAPI(title="Insight-Invest API v2.0")

# ë©”íƒ€ë°ì´í„° ë¼ìš°í„° (PostgreSQL)
app.include_router(meta.router)

# ì‹œê³„ì—´ ë°ì´í„° ë¼ìš°í„° (Athena + Iceberg)
app.include_router(price.router)
app.include_router(backtest.router)
app.include_router(portfolio.router)
app.include_router(regime.router)
```

### ğŸ“¡ API ì—”ë“œí¬ì¸íŠ¸

#### 1. ë©”íƒ€ë°ì´í„° API (PostgreSQL)

```python
# GET /api/meta
# GET /api/meta/tickers
# GET /api/meta/{meta_id}

@router.get("/meta")
def get_meta():
    """ë©”íƒ€ë°ì´í„° ì¡°íšŒ (PostgreSQL)"""
    with session_local() as session:
        query = session.query(TbMeta)
        df = pd.read_sql(query.statement, session.bind)
        return df.to_dict(orient="records")
```

#### 2. ê°€ê²© ë°ì´í„° API (Athena + Iceberg)

```python
# GET /api/price/daily?ticker=AAPL&start_date=2024-01-01
# GET /api/price/aggregate?tickers=AAPL,GOOGL&start_date=2024-01-01
# GET /api/price/cross-market?us_ticker=AAPL&kr_ticker=005930

from db.athena_client import get_athena_client

athena = get_athena_client()

@router.get("/price/daily")
def get_daily_prices(ticker: str, start_date: str):
    """ì¼ë³„ ê°€ê²© ì¡°íšŒ (Athena)"""

    # 1. meta_id ì¡°íšŒ (PostgreSQL, ìºì‹±)
    meta_id = get_meta_id_cached(ticker)

    # 2. Athena ì¿¼ë¦¬
    sql = f"""
    SELECT
        trade_date,
        close,
        adj_close,
        gross_return
    FROM market_data.us_stocks_price
    WHERE meta_id = {meta_id}
      AND trade_date >= DATE '{start_date}'
    ORDER BY trade_date
    """

    # 3. Arrow â†’ JSON (Pandas ì—†ìŒ!)
    return athena.query_to_json(sql, database='market_data')
```

#### 3. í¬íŠ¸í´ë¦¬ì˜¤ API (Cross-schema JOIN)

```python
# GET /api/portfolio/performance?port_id=1&start_date=2024-01-01

@router.get("/portfolio/performance")
def get_portfolio_performance(port_id: int, start_date: str):
    """í¬íŠ¸í´ë¦¬ì˜¤ ì„±ê³¼ ë¶„ì„ (ì—¬ëŸ¬ ìŠ¤í‚¤ë§ˆ ì¡°ì¸)"""

    sql = f"""
    WITH holdings AS (
        SELECT
            p.trade_date,
            p.meta_id,
            p.adj_close,
            r.weight
        FROM market_data.us_stocks_price p
        JOIN portfolio.tb_rebalance r
            ON p.meta_id = r.meta_id
            AND p.trade_date >= r.rebal_date
        WHERE r.port_id = {port_id}
          AND p.trade_date >= DATE '{start_date}'
    ),
    daily_value AS (
        SELECT
            trade_date,
            SUM(adj_close * weight) as portfolio_value
        FROM holdings
        GROUP BY trade_date
    )
    SELECT
        dv.trade_date,
        dv.portfolio_value,
        n.value as nav_value,
        (dv.portfolio_value / LAG(dv.portfolio_value) OVER (ORDER BY dv.trade_date) - 1) as daily_return
    FROM daily_value dv
    JOIN portfolio.tb_nav n
        ON dv.trade_date = n.trade_date
        AND n.port_id = {port_id}
    ORDER BY dv.trade_date
    """

    return athena.query_to_json(sql, database='market_data')
```

#### 4. ë°±í…ŒìŠ¤íŠ¸ API (Compute + Athena)

```python
# POST /api/backtest
# Body: {meta_ids: [1,2,3], algorithm: "eq", start_date: "2024-01-01"}

@router.post("/backtest")
async def run_backtest(request: BacktestRequest):
    """ë°±í…ŒìŠ¤íŠ¸ ì‹¤í–‰"""

    # 1. Athenaì—ì„œ ê°€ê²© ë°ì´í„° ì¡°íšŒ
    sql = f"""
    SELECT
        meta_id,
        trade_date,
        adj_close
    FROM market_data.us_stocks_price
    WHERE meta_id IN ({','.join(map(str, request.meta_ids))})
      AND trade_date >= DATE '{request.start_date}'
    ORDER BY trade_date, meta_id
    """

    # 2. Arrow Tableë¡œ ë°›ê¸°
    arrow_table = athena.query_to_arrow(sql)

    # 3. Arrow Computeë¡œ ë°±í…ŒìŠ¤íŠ¸ ê³„ì‚°
    from module.backtest_arrow import BacktestArrow

    bt = BacktestArrow()
    results = bt.calculate(
        price_table=arrow_table,
        algorithm=request.algorithm,
        start_date=request.start_date,
        end_date=request.end_date
    )

    return results
```

---

## ë¹„ìš© ë¶„ì„

### ğŸ’° ì›”ê°„ ë¹„ìš© ìƒì„¸

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  êµ¬ì„± ìš”ì†Œ                    â”‚ í˜„ì¬    â”‚ ì‹ ê·œ    â”‚ ì°¨ì´     â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  A. ë©”íƒ€ë°ì´í„° ìŠ¤í† ì–´ (PostgreSQL)                           â”‚
â”‚     - RDS ì¸ìŠ¤í„´ìŠ¤ (db.t3.micro)   $15.33   $15.33   $0.00  â”‚
â”‚     - ìŠ¤í† ë¦¬ì§€ (50GB â†’ 10GB)       $5.75    $1.15   -$4.60  â”‚
â”‚     - ë°±ì—… (50GB â†’ 10GB)           $4.75    $0.95   -$3.80  â”‚
â”‚     - I/O (90% ê°ì†Œ)               $0.45    $0.00   -$0.45  â”‚
â”‚     ì†Œê³„                           $26.28   $17.43  -$8.85  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  B. ì‹œê³„ì—´ ë°ì´í„° ë ˆì´í¬ (Iceberg + S3)                     â”‚
â”‚     - S3 ìŠ¤í† ë¦¬ì§€ (1GB, ì••ì¶•)      $0.00    $0.02   +$0.02  â”‚
â”‚     - S3 API ìš”ì²­ (GET)            $0.00    $0.02   +$0.02  â”‚
â”‚     - S3 API ìš”ì²­ (PUT)            $0.00    $0.03   +$0.03  â”‚
â”‚     - Data Transfer                $0.00    $0.08   +$0.08  â”‚
â”‚     ì†Œê³„                           $0.00    $0.15   +$0.15  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  C. ë©”íƒ€ìŠ¤í† ì–´ (Glue Catalog)                               â”‚
â”‚     - Glue Database (4ê°œ)          $0.00    $0.00   $0.00   â”‚
â”‚     - Glue API í˜¸ì¶œ (10ë§Œ/ì›”)      $0.00    $0.10   +$0.10  â”‚
â”‚     ì†Œê³„                           $0.00    $0.10   +$0.10  â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  D. ì¿¼ë¦¬ ì—”ì§„ (Athena)                                      â”‚
â”‚     - ì¿¼ë¦¬ ì‹¤í–‰ (5GB ìŠ¤ìº”/ì›”)      $0.00    $0.025  +$0.025 â”‚
â”‚     - ê²°ê³¼ ì €ì¥ (S3)               $0.00    $0.20   +$0.20  â”‚
â”‚     ì†Œê³„                           $0.00    $0.225  +$0.225 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  E. API ì„œë²„ (ECS Fargate) - ë³€ê²½ ì—†ìŒ                      â”‚
â”‚     - 0.25 vCPU, 512 MB            $13.00   $13.00  $0.00   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  F. Data Ingestion (ECS Tasks) - ë³€ê²½ ì—†ìŒ                  â”‚
â”‚     - US/KR/Macro Updaters         $1.09    $1.09   $0.00   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ì´ ë¹„ìš©                           $40.37   $31.96  -$8.41  â”‚
â”‚  (ALB $16 ì œì™¸)                                             â”‚
â”‚                                                              â”‚
â”‚  ì ˆê°ë¥ : 20.8%                                              â”‚
â”‚  ì—°ê°„ ì ˆê°: $100.92                                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ğŸ“Š ë°ì´í„° ì¦ê°€ì— ë”°ë¥¸ ë¹„ìš© ì‹œë®¬ë ˆì´ì…˜

```
ì‹œë‚˜ë¦¬ì˜¤: ì¢…ëª© 500ê°œ â†’ 2000ê°œ, 5ë…„ â†’ 10ë…„ ë°ì´í„°

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ì—°ë„  â”‚ ë°ì´í„° í¬ê¸° â”‚ í˜„ì¬ ì•„í‚¤í…ì²˜ â”‚ ì‹ ê·œ ì•„í‚¤í…ì²˜ â”‚ ì ˆê°   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  Y0    â”‚ 3.4 GB      â”‚ $26.28/ì›”     â”‚ $14.83/ì›”     â”‚ 44%   â”‚
â”‚  Y1    â”‚ 5 GB        â”‚ $30.15/ì›”     â”‚ $15.05/ì›”     â”‚ 50%   â”‚
â”‚  Y2    â”‚ 8 GB        â”‚ $37.80/ì›”     â”‚ $15.40/ì›”     â”‚ 59%   â”‚
â”‚  Y3    â”‚ 15 GB       â”‚ $52.00/ì›”     â”‚ $16.10/ì›”     â”‚ 69%   â”‚
â”‚  Y5    â”‚ 40 GB       â”‚ $95.00/ì›”     â”‚ $18.50/ì›”     â”‚ 81%   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  5ë…„ ëˆ„ì  ë¹„ìš©                                              â”‚
â”‚        â”‚             â”‚ $2,910        â”‚ $1,014        â”‚ $1,896â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

ê²°ë¡ : ë°ì´í„°ê°€ ì»¤ì§ˆìˆ˜ë¡ ì ˆê° íš¨ê³¼ ì¦ê°€!
```

### ğŸ’¡ ë¹„ìš© ìµœì í™” ì „ëµ

#### 1. S3 Intelligent-Tiering

```python
# 3ê°œì›” ì´ìƒ ëœ ë°ì´í„° ìë™ìœ¼ë¡œ ì €ë ´í•œ í‹°ì–´ë¡œ ì´ë™

aws s3api put-bucket-intelligent-tiering-configuration \
  --bucket insight-invest-datalake \
  --id auto-archive \
  --intelligent-tiering-configuration '{
    "Id": "auto-archive",
    "Status": "Enabled",
    "Tierings": [
      {
        "Days": 90,
        "AccessTier": "ARCHIVE_ACCESS"
      },
      {
        "Days": 180,
        "AccessTier": "DEEP_ARCHIVE_ACCESS"
      }
    ]
  }'

# ë¹„ìš© ì ˆê°:
# - Standard: $0.023/GB
# - Archive: $0.004/GB (83% ì ˆê°!)
# - Deep Archive: $0.00099/GB (96% ì ˆê°!)
```

#### 2. Athena ì¿¼ë¦¬ ìµœì í™”

```sql
-- âœ… Best Practice 1: íŒŒí‹°ì…˜ í•„í„° í•­ìƒ ì‚¬ìš©
WHERE trade_date >= DATE '2024-01-01'  -- íŒŒí‹°ì…˜ ì»¬ëŸ¼!

-- âœ… Best Practice 2: í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒ
SELECT trade_date, adj_close  -- * ì‚¬ìš© ê¸ˆì§€!

-- âœ… Best Practice 3: CTASë¡œ ìì£¼ ì‚¬ìš©í•˜ëŠ” ì¿¼ë¦¬ ë¯¸ë¦¬ ê³„ì‚°
CREATE TABLE analytics.monthly_summary AS
SELECT DATE_TRUNC('month', trade_date) as month,
       AVG(adj_close) as avg_price
FROM market_data.us_stocks_price
WHERE trade_date >= DATE '2024-01-01'
GROUP BY DATE_TRUNC('month', trade_date)

-- ì´í›„ ë¹ ë¥´ê³  ì €ë ´í•˜ê²Œ ì¡°íšŒ
SELECT * FROM analytics.monthly_summary
```

#### 3. ê²°ê³¼ ìºì‹±

```python
# Redisë¡œ ìì£¼ ì¡°íšŒí•˜ëŠ” ê²°ê³¼ ìºì‹±
import redis
import json

redis_client = redis.Redis(host='redis', port=6379)

@router.get("/price/daily")
def get_daily_prices(ticker: str, start_date: str):
    # ìºì‹œ í‚¤
    cache_key = f"price:daily:{ticker}:{start_date}"

    # ìºì‹œ í™•ì¸ (5ë¶„)
    cached = redis_client.get(cache_key)
    if cached:
        return json.loads(cached)

    # Athena ì¿¼ë¦¬
    result = athena.query_to_json(sql)

    # ìºì‹œ ì €ì¥
    redis_client.setex(cache_key, 300, json.dumps(result))

    return result

# íš¨ê³¼: ë°˜ë³µ ì¿¼ë¦¬ ë¹„ìš© 0ì›, ì‘ë‹µ ì‹œê°„ 99% ê°ì†Œ
```

---

## ë§ˆì´ê·¸ë ˆì´ì…˜ ê³„íš

### ğŸ“… 6ì£¼ ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡œë“œë§µ

#### Week 1: ì¤€ë¹„ ë‹¨ê³„

```bash
# Day 1-2: AWS ì¸í”„ë¼ ì„¤ì •
- S3 ë²„í‚· ìƒì„±
- Glue ë°ì´í„°ë² ì´ìŠ¤ ìƒì„± (4ê°œ)
- IAM ì—­í•  ì„¤ì •
- Athena ì›Œí¬ê·¸ë£¹ ìƒì„±

# Day 3-4: ë¡œì»¬ ê°œë°œ í™˜ê²½ êµ¬ì¶•
- PyIceberg ì„¤ì¹˜
- Athena í´ë¼ì´ì–¸íŠ¸ ê°œë°œ
- ë¡œì»¬ í…ŒìŠ¤íŠ¸

# Day 5: POC
- ì†Œê·œëª¨ ë°ì´í„°ë¡œ Iceberg í…Œì´ë¸” ìƒì„±
- Athena ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸
```

#### Week 2-3: Iceberg í…Œì´ë¸” ìƒì„± ë° ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜

```python
# í…Œì´ë¸” ìƒì„±
python scripts/create_iceberg_tables.py

# ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ (ë°°ì¹˜ë³„)
python scripts/migrate_to_iceberg.py --table us_stocks_price --batch-size 100000
python scripts/migrate_to_iceberg.py --table kr_stocks_price --batch-size 100000
python scripts/migrate_to_iceberg.py --table tb_nav --batch-size 50000
python scripts/migrate_to_iceberg.py --table tb_rebalance --batch-size 10000
python scripts/migrate_to_iceberg.py --table tb_macro_data --batch-size 10000

# ê²€ì¦
python scripts/verify_migration.py
```

#### Week 4: API ê°œë°œ

```python
# Athena í´ë¼ì´ì–¸íŠ¸ í†µí•©
# FastAPI ë¼ìš°í„° ì—…ë°ì´íŠ¸
# Arrow ë„¤ì´í‹°ë¸Œ ì²˜ë¦¬
# í…ŒìŠ¤íŠ¸ ì½”ë“œ ì‘ì„±
```

#### Week 5: ì´ì¤‘ ì“°ê¸° ë° í…ŒìŠ¤íŠ¸

```python
# ì‹ ê·œ ë°ì´í„°ëŠ” PostgreSQL + Iceberg ë™ì‹œ ì“°ê¸°
# 1ì£¼ì¼ê°„ ë°ì´í„° ì¼ê´€ì„± ëª¨ë‹ˆí„°ë§
# API ì‘ë‹µ ì‹œê°„ ë¹„êµ
# ë¹„ìš© ëª¨ë‹ˆí„°ë§
```

#### Week 6: ì „í™˜ ì™„ë£Œ

```python
# Icebergë¡œ ì™„ì „ ì „í™˜
# PostgreSQL ì‹œê³„ì—´ í…Œì´ë¸” ì•„ì¹´ì´ë¸Œ
# ëª¨ë‹ˆí„°ë§ ëŒ€ì‹œë³´ë“œ ì„¤ì •
# ë¬¸ì„œí™”
```

### ğŸ”„ ìƒì„¸ ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸

```python
# server/scripts/migrate_to_iceberg.py
import sys
import pandas as pd
from datetime import datetime
from pyiceberg.catalog import load_catalog
from sqlalchemy import text
import pyarrow as pa
import pyarrow.compute as pc

sys.path.insert(0, "/Users/achii/Python_project/Insight-Invest/server")
from db.client import session_local

def migrate_table(
    table_name: str,
    glue_database: str,
    batch_size: int = 100000
):
    """
    PostgreSQL â†’ Iceberg ë§ˆì´ê·¸ë ˆì´ì…˜

    Args:
        table_name: í…Œì´ë¸” ì´ë¦„ (ì˜ˆ: "tb_price")
        glue_database: Glue ë°ì´í„°ë² ì´ìŠ¤ (ì˜ˆ: "market_data")
        batch_size: ë°°ì¹˜ í¬ê¸°
    """
    print(f"\n{'='*60}")
    print(f"ğŸš€ Migrating {table_name} to {glue_database}")
    print(f"{'='*60}\n")

    # 1. Iceberg Catalog ì—°ê²°
    catalog = load_catalog(
        "glue",
        **{
            "type": "glue",
            "s3.region": "ap-northeast-2",
            "warehouse": "s3://insight-invest-datalake/warehouse"
        }
    )

    # 2. Iceberg í…Œì´ë¸” ë¡œë“œ
    iceberg_table_name = f"{glue_database}.{table_name}"
    try:
        table = catalog.load_table(iceberg_table_name)
        print(f"âœ… Loaded existing table: {iceberg_table_name}")
    except Exception as e:
        print(f"âŒ Table not found: {iceberg_table_name}")
        print(f"   Please create the table first using create_iceberg_tables.py")
        return False

    # 3. PostgreSQLì—ì„œ ì „ì²´ row ìˆ˜ í™•ì¸
    with session_local() as session:
        count_query = f"SELECT COUNT(*) FROM {table_name}"
        total_rows = session.execute(text(count_query)).scalar()
        print(f"ğŸ“Š Total rows in PostgreSQL: {total_rows:,}\n")

        if total_rows == 0:
            print("âš ï¸ No data to migrate")
            return True

        # 4. ë°°ì¹˜ë³„ë¡œ ë§ˆì´ê·¸ë ˆì´ì…˜
        offset = 0
        migrated = 0

        while offset < total_rows:
            # Pandasë¡œ ë°°ì¹˜ ì½ê¸°
            query = f"SELECT * FROM {table_name} ORDER BY 1 LIMIT {batch_size} OFFSET {offset}"
            df = pd.read_sql(query, session.bind)

            if df.empty:
                break

            # Arrow Tableë¡œ ë³€í™˜ (Pandas â†’ Arrow)
            arrow_table = pa.Table.from_pandas(df, preserve_index=False)

            # Icebergì— append
            table.append(arrow_table)

            migrated += len(df)
            offset += batch_size

            progress = (migrated / total_rows) * 100
            print(f"â³ Progress: {migrated:,} / {total_rows:,} ({progress:.1f}%)")

        print(f"\nâœ… Migration completed: {migrated:,} rows")
        return True


def verify_migration(
    table_name: str,
    glue_database: str
):
    """ë§ˆì´ê·¸ë ˆì´ì…˜ ê²€ì¦"""
    print(f"\n{'='*60}")
    print(f"ğŸ” Verifying {table_name}")
    print(f"{'='*60}\n")

    # PostgreSQL row count
    with session_local() as session:
        pg_count = session.execute(
            text(f"SELECT COUNT(*) FROM {table_name}")
        ).scalar()
        print(f"PostgreSQL: {pg_count:,} rows")

    # Iceberg row count (Athena ì‚¬ìš©)
    import boto3
    import time

    athena = boto3.client('athena', region_name='ap-northeast-2')

    query = f"SELECT COUNT(*) as cnt FROM {glue_database}.{table_name}"

    response = athena.start_query_execution(
        QueryString=query,
        QueryExecutionContext={'Database': glue_database},
        ResultConfiguration={
            'OutputLocation': 's3://insight-invest-athena-results/'
        }
    )

    query_id = response['QueryExecutionId']

    # ëŒ€ê¸°
    for i in range(30):
        status = athena.get_query_execution(QueryExecutionId=query_id)
        state = status['QueryExecution']['Status']['State']

        if state == 'SUCCEEDED':
            break
        elif state in ['FAILED', 'CANCELLED']:
            print(f"âŒ Athena query failed")
            return False

        time.sleep(1)

    # ê²°ê³¼ ì¡°íšŒ
    result = athena.get_query_results(QueryExecutionId=query_id)
    iceberg_count = int(result['ResultSet']['Rows'][1]['Data'][0]['VarCharValue'])

    print(f"Iceberg:    {iceberg_count:,} rows")

    # ë¹„êµ
    if pg_count == iceberg_count:
        print("\nâœ… Verification PASSED!")
        return True
    else:
        diff = abs(pg_count - iceberg_count)
        print(f"\nâŒ Verification FAILED! Difference: {diff:,} rows")
        return False


if __name__ == "__main__":
    import argparse

    parser = argparse.ArgumentParser()
    parser.add_argument("--table", required=True, help="Table name")
    parser.add_argument("--database", required=True, help="Glue database name")
    parser.add_argument("--batch-size", type=int, default=100000)
    parser.add_argument("--verify-only", action="store_true")

    args = parser.parse_args()

    if args.verify_only:
        verify_migration(args.table, args.database)
    else:
        success = migrate_table(args.table, args.database, args.batch_size)
        if success:
            verify_migration(args.table, args.database)
```

---

## ìš´ì˜ ê°€ì´ë“œ

### ğŸ“Š ëª¨ë‹ˆí„°ë§

#### 1. CloudWatch ëŒ€ì‹œë³´ë“œ

```yaml
Dashboard: insight-invest-datalake

Widgets:
  - Athena ì¿¼ë¦¬ ì‹¤í–‰ ìˆ˜ (ì¼ë³„)
  - Athena ìŠ¤ìº” ë°ì´í„°ëŸ‰ (ì¼ë³„)
  - Athena ë¹„ìš© (ì¼ë³„)
  - S3 GET/PUT ìš”ì²­ ìˆ˜
  - API ì‘ë‹µ ì‹œê°„ (p50, p95, p99)
  - ECS Task ì‹¤í–‰ ìƒíƒœ
```

#### 2. ë¹„ìš© ì•ŒëŒ

```bash
# Athena ì¼ì¼ ë¹„ìš©ì´ $1 ì´ˆê³¼ ì‹œ ì•Œë¦¼
aws cloudwatch put-metric-alarm \
  --alarm-name athena-daily-cost-alert \
  --metric-name EstimatedCharges \
  --namespace AWS/Athena \
  --statistic Sum \
  --period 86400 \
  --threshold 1.0 \
  --comparison-operator GreaterThanThreshold
```

#### 3. ë°ì´í„° í’ˆì§ˆ ì²´í¬

```python
# ë§¤ì¼ ì‹¤í–‰: ë°ì´í„° ì¼ê´€ì„± í™•ì¸
def check_data_quality():
    """ë°ì´í„° í’ˆì§ˆ ì²´í¬"""

    # 1. ìµœì‹  ë°ì´í„° í™•ì¸
    sql = """
    SELECT MAX(trade_date) as latest_date
    FROM market_data.us_stocks_price
    """
    result = athena.query_to_json(sql)
    latest_date = result[0]['latest_date']

    # 2. ì•Œë¦¼
    from datetime import date, timedelta
    if date.fromisoformat(latest_date) < date.today() - timedelta(days=2):
        send_alert(f"âš ï¸ Data is outdated: {latest_date}")

    # 3. NULL ì²´í¬
    sql = """
    SELECT COUNT(*) as null_count
    FROM market_data.us_stocks_price
    WHERE adj_close IS NULL
      AND trade_date >= CURRENT_DATE - INTERVAL '7' DAY
    """
    result = athena.query_to_json(sql)
    if result[0]['null_count'] > 0:
        send_alert(f"âš ï¸ Found {result[0]['null_count']} NULL values")
```

### ğŸ”§ ìš´ì˜ ì‘ì—…

#### 1. Iceberg í…Œì´ë¸” ì••ì¶• (Compaction)

```python
# ì£¼ê¸°ì ìœ¼ë¡œ ì‹¤í–‰: ì‘ì€ íŒŒì¼ë“¤ì„ í° íŒŒì¼ë¡œ ë³‘í•©
from pyiceberg.table import Table

def compact_table(table_name: str):
    """Iceberg í…Œì´ë¸” ì••ì¶•"""
    table: Table = catalog.load_table(table_name)

    # Rewrite data files
    table.rewrite_data_files(
        target_file_size_bytes=134217728  # 128 MB
    )

    print(f"âœ… Compaction completed for {table_name}")
```

#### 2. ì˜¤ë˜ëœ ìŠ¤ëƒ…ìƒ· ì‚­ì œ

```python
# 30ì¼ ì´ìƒ ëœ ìŠ¤ëƒ…ìƒ· ì‚­ì œ (ìŠ¤í† ë¦¬ì§€ ì ˆì•½)
def expire_snapshots(table_name: str, days: int = 30):
    """ì˜¤ë˜ëœ ìŠ¤ëƒ…ìƒ· ì‚­ì œ"""
    from datetime import timedelta

    table: Table = catalog.load_table(table_name)

    table.expire_snapshots(
        older_than=datetime.now() - timedelta(days=days)
    )

    print(f"âœ… Expired snapshots older than {days} days")
```

#### 3. í†µê³„ ì •ë³´ ì—…ë°ì´íŠ¸

```sql
-- Athena/Glueì˜ í…Œì´ë¸” í†µê³„ ì—…ë°ì´íŠ¸ (ì¿¼ë¦¬ ìµœì í™”)
ANALYZE TABLE market_data.us_stocks_price COMPUTE STATISTICS;
```

### ğŸš¨ íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

#### ë¬¸ì œ 1: Athena ì¿¼ë¦¬ ëŠë¦¼

```
ì›ì¸: íŒŒí‹°ì…˜ í”„ë£¨ë‹ ë¯¸ì ìš©
í•´ê²°: WHERE ì ˆì— íŒŒí‹°ì…˜ ì»¬ëŸ¼ í•„í„° ì¶”ê°€

-- âŒ ëŠë¦¼
SELECT * FROM market_data.us_stocks_price WHERE meta_id = 123

-- âœ… ë¹ ë¦„
SELECT * FROM market_data.us_stocks_price
WHERE trade_date >= DATE '2024-11-01'  -- íŒŒí‹°ì…˜ ì»¬ëŸ¼!
  AND meta_id = 123
```

#### ë¬¸ì œ 2: Athena ë¹„ìš© ê¸‰ì¦

```
ì›ì¸: SELECT * ì‚¬ìš©, íŒŒí‹°ì…˜ ë¯¸ì‚¬ìš©
í•´ê²°:
  1. í•„ìš”í•œ ì»¬ëŸ¼ë§Œ ì„ íƒ
  2. íŒŒí‹°ì…˜ í•„í„° ì¶”ê°€
  3. CTASë¡œ ë¯¸ë¦¬ ê³„ì‚°
```

#### ë¬¸ì œ 3: Iceberg ë©”íƒ€ë°ì´í„° ì¶©ëŒ

```
ì›ì¸: ë™ì‹œ ì“°ê¸°
í•´ê²°: Icebergì˜ Optimistic Concurrency Control í™œìš©
  - ìë™ ì¬ì‹œë„
  - ì¶©ëŒ ì‹œ ë³‘í•©
```

---

## ğŸ“š ì°¸ê³  ìë£Œ

### ê³µì‹ ë¬¸ì„œ

- [Apache Iceberg Documentation](https://iceberg.apache.org/)
- [AWS Athena Iceberg Support](https://docs.aws.amazon.com/athena/latest/ug/querying-iceberg.html)
- [AWS Glue Data Catalog](https://docs.aws.amazon.com/glue/latest/dg/catalog-and-crawler.html)
- [PyIceberg GitHub](https://github.com/apache/iceberg-python)
- [PyArrow Documentation](https://arrow.apache.org/docs/python/)

### ì¶”ê°€ ê°€ì´ë“œ

- [HYBRID_ARCHITECTURE_MIGRATION.md](./HYBRID_ARCHITECTURE_MIGRATION.md) - ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„¸ ê°€ì´ë“œ
- [ATHENA_IMPLEMENTATION_GUIDE.md](./ATHENA_IMPLEMENTATION_GUIDE.md) - Athena êµ¬í˜„ ê°€ì´ë“œ
- [TRINO_FOR_DISTRIBUTED_SCHEMA.md](./TRINO_FOR_DISTRIBUTED_SCHEMA.md) - Trino ëŒ€ì•ˆ

---

## ğŸ¯ ë‹¤ìŒ ë‹¨ê³„

### Phase 1: POC (1ì£¼)

- [ ] S3 ë²„í‚· ìƒì„±
- [ ] Glue ë°ì´í„°ë² ì´ìŠ¤ ìƒì„±
- [ ] ì†Œê·œëª¨ Iceberg í…Œì´ë¸” í…ŒìŠ¤íŠ¸
- [ ] Athena ì¿¼ë¦¬ í…ŒìŠ¤íŠ¸

### Phase 2: ê°œë°œ (2-3ì£¼)

- [ ] Iceberg í…Œì´ë¸” ìƒì„± ìŠ¤í¬ë¦½íŠ¸
- [ ] ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸
- [ ] Athena í´ë¼ì´ì–¸íŠ¸ ê°œë°œ
- [ ] FastAPI ë¼ìš°í„° ì—…ë°ì´íŠ¸

### Phase 3: ë§ˆì´ê·¸ë ˆì´ì…˜ (2ì£¼)

- [ ] ë°ì´í„° ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹¤í–‰
- [ ] ê²€ì¦
- [ ] ì´ì¤‘ ì“°ê¸°
- [ ] ì „í™˜

### Phase 4: ìµœì í™” (1ì£¼)

- [ ] ì„±ëŠ¥ íŠœë‹
- [ ] ë¹„ìš© ìµœì í™”
- [ ] ëª¨ë‹ˆí„°ë§ ì„¤ì •
- [ ] ë¬¸ì„œí™”

---

**ì‘ì„±ì**: AI Assistant  
**ìµœì¢… ìˆ˜ì •**: 2024-11-22  
**ë²„ì „**: 2.0
